"use strict";var app=angular.module("petApp",["ngResource","ngRoute","ui.bootstrap","ui.router"]);app.config(["$routeProvider","$stateProvider","USER_ROLES",function(e,t,r){e.when("/login",{templateUrl:"views/login.html",controller:"LoginController",controllerAs:"login"}).when("/main",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).when("/order",{templateUrl:"views/order.html",controller:"OrderController",controllerAs:"order"}).when("/orderHistory",{templateUrl:"views/orderHistory.html",controller:"OrderHistoryController",controllerAs:"orderHistory"}).otherwise({redirectTo:"/login"}),t.state("index",{url:"/views",templateUrl:"views/index.html",data:{authorizedRoles:[r.admin,r.editor]}})}]),app.run(["$rootScope","ENVIRONMENT",function(e,t){e.baseUrl=t.baseUrl}]),app.factory("AuthService",["$http","$rootScope","Session",function(e,t,r){var n={};return n.login=function(n){return e.post(t.baseUrl+"/login",n).then(function(e){return r.create(e.data.emailId,e.data.userId,"admin"),e.data})},n.isAuthenticated=function(){return!!r.userId},n.currentUser=function(e){r.currentUser=e},n.isAuthorized=function(e){return n.isAuthenticated()},n}]),app.factory("CartService",["$http","$q","$rootScope",function(e,t,r){var n=function(t){return e.post(r.baseUrl+"/cart/save",t).success(function(e){console.log("Saved Cart Item successfully!")}).error(function(e){console.log("Error while saving Cart Item")})},o=function(t){return e.post(r.baseUrl+"/cart/delete",t).success(function(e){console.log("Deleted Cart Item successfully!")}).error(function(e){console.log("Error while Delete Cart Item")})},a=function(t){return e.post(r.baseUrl+"/cart/update",t).success(function(e){console.log("Updated Cart Item successfully!")}).error(function(e){console.log("Error while updating Cart Item")})},c=function(t){return e({url:r.baseUrl+"/cart/load/"+t,dataType:"json",data:"",headers:{"Content-Type":"application/json"}}).success(function(e){console.log("Loaded Cart Items successfully!")}).error(function(e){console.log("Error while loading Cart Items")})};return{saveCartItem:n,deleteCartItem:o,loadCartItems:c,updateCartItem:a}}]),app.constant("AUTH_EVENTS",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized"}),app.constant("USER_ROLES",{all:"*",admin:"admin",editor:"editor",guest:"guest"}),app.constant("ENVIRONMENT",{mode:"dev",baseUrl:"http://localhost:8080/pet-supplies"}),app.constant("ERROR",{}),app.service("LoginService",["$http","$q","$rootScope",function(e,t,r){var n=t.defer(),o=function(t){e({url:r.baseUrl+"/login",dataType:"json",method:"POST",data:t,headers:{"Content-Type":"application/json"}}).success(function(e){n.resolve(e)}).error(function(e){n.reject(),console.log("Failed to login")});return n.promise};return{loginToApp:o}}]),app.factory("OrderService",["$http","$q","$rootScope",function(e,t,r){var n=function(t){return e.post(r.baseUrl+"/order/save",t).success(function(e){console.log("Saved Cart Item successfully!")}).error(function(e){console.log("Error while saving Cart Item")})};return{placeOrder:n}}]),app.factory("PaymentService",["$http","$q","$rootScope",function(e,t,r){var n=function(t){return e.post(r.baseUrl+"/payment/place",t).success(function(e){console.log("Saved Cart Item successfully!")}).error(function(e){console.log("Error while saving Cart Item")})};return{savePayment:n}}]),app.factory("ProductsService",["$http","$q","$rootScope",function(e,t,r){return{loadAllPets:function(n){var o=t.defer();e({url:r.baseUrl+"/category/"+n,dataType:"json",method:"GET",data:"",headers:{"Content-Type":"application/json"}}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)});return o.promise}}}]),app.factory("ReferentialDataService",[function(){return{getAllPets:function(){var e=[{code:"BIRD",name:"Birds"},{code:"CAT",name:"Cats"},{code:"DOG",name:"Dogs"}];return e}}}]),app.service("Session",function(){this.currentUser={},this.cartItems={},this.isItemsPresent={},this.create=function(e,t,r){this.id=e,this.userId=t,this.userRole=r},this.destroy=function(){this.id=null,this.userId=null,this.userRole=null}}),app.controller("LoginController",["$scope","LoginService","$location","$rootScope","AuthService","AUTH_EVENTS","USER_ROLES",function(e,t,r,n,o,a,c){var s={emailId:"",password:""};e.credentials=s,e.invalidCredentials="",e.currentUser=null,e.userRoles=c,e.isAuthorized=o.isAuthorized(c),e.loginApp=function(){o.login(e.credentials).then(function(t){n.$broadcast(a.loginSuccess),e.setCurrentUser(t),o.isAuthorized()?(o.currentUser(e.currentUser),r.path("/main")):(e.invalidCredentials="Invalid credentials! Please check username & paswword",e.credentials=s,r.path("/login"))},function(){n.$broadcast(a.loginFailed)})},e.setCurrentUser=function(t){e.currentUser=t}}]),app.controller("MainCtrl",["$scope","ReferentialDataService","ProductsService","CartService","USER_ROLES","AuthService","$location","Session",function(e,t,r,n,o,a,c,s){e.cartItems={},n.loadCartItems(s.currentUser.userId).then(function(t){var r=t.data;void 0!=r&&r.length>0&&angular.forEach(r,function(t){e.cartItems[t.id]=t}),d()}),e.isItemsPresent=!1,e.currentUser=null,e.petsList=t.getAllPets(),e.userName=s.currentUser.userName,e.load=function(t){e.pettype=t,e.products=t,r.loadAllPets(t).then(function(t){e.catagories=t})},e.addToCart=function(t){e.isItemsPresent=!0;var r=l(t);i(r)?angular.forEach(e.cartItems,function(e,t){p(e,r)&&(e.quantity=r.quantity,n.updateCartItem(r))}):n.saveCartItem(r).then(function(t){e.cartItems[t.data.id]=t.data,d()})};var i=function(t){var r=!1;return angular.forEach(e.cartItems,function(e,n){m(e,t)&&(r=!0)}),r};e.showCartItems=function(){0!=e.cartItems.length&&(e.isItemsPresent=!0)},e.removeCartItem=function(t){i(t)&&(delete e.cartItems[t.id],u(t)),0==e.cartItems.length&&(e.isItemsPresent=!1)};var u=function(e){n.deleteCartItem(e),d()};e.setCurrentUser=function(t){e.currentUser=t};var l=function(e){var t={id:e.id,productId:e.productId,quantity:e.quantity,productName:e.productName,price:e.price,currency:e.currency,userId:s.currentUser.userId};return t},d=function(){e.cartItemSize=Object.keys(e.cartItems).length},p=function(e,t){return m(e,t)&&e.quantity!==t.quantity},m=function(e,t){return e.productId===t.productId&&e.userId===t.userId};e.navToOrderHistory=function(){c.path("/orderHistory")},s.cartItems=e.cartItems,e.signOut=function(){c.path("/login")}}]),app.controller("OrderController",["$scope","$location","Session","OrderService",function(e,t,r,n){e.currentUser=r.currentUser,e.cartItems=r.cartItems,e.userName=r.currentUser.userName,e.cartItemSize=Object.keys(e.cartItems).length,e.cartItemSize>0&&(e.isItemsPresent=!0),e.load=function(e){t.path("/main")};var o=r.currentUser.address;e.address=o.address,e.userName=e.currentUser.userName,e.city=o.city,e.state=o.state,e.zipCode=o.zipCode,e.email=o.email,e.phone=o.phone,e.country=o.country,e.payAndPlaceOrder=function(){var t=[];angular.forEach(e.cartItems,function(e,r){void 0!=e&&t.push(a(e))}),t.length>0&&n.placeOrder(t)};var a=function(t){var r={};return r.userId=e.currentUser.userId,r.productId=t.productId,r.productName=t.productName,r.productPrice=t.price,r.currency=t.currency,r.quantity=t.quantity,r.status=e.userName,r.shippingAddress=c(),r.orderDate=new Date,r},c=function(){var t=" , ";return e.userName+t+e.country}}]),app.controller("OrderHistoryController",["$scope","$location","Session",function(e,t,r){}]),app.controller("PlaceOrderController",["$scope","$modalInstance","items","CartService","$location",function(e,t,r,n,o){e.itemsInPopup=r,e.totalPrice=function(){var t=0,n=1;return angular.forEach(r,function(r,o){void 0!=r&&(n=parseInt(r.quantity),t+=n*parseInt(r.price),e.currencyToPay=r.currency)}),t}(),e.onChangeQuantity=function(e){n.updateCartItem(e)},e.deleteCartItem=function(e){n.deleteCartItem(e)},e.proceedToPay=function(){o.path("/order"),t.dismiss("cancel")},e.close=function(){t.dismiss("cancel")}}]),app.controller("PopupsController",["$scope","$modal",function(e,t){e.openPlaceOrder=function(e){t.open({templateUrl:"views/checkout.html",controller:"PlaceOrderController",resolve:{items:function(){return e}}})}}]),app.directive("dynamicTemplate",function(){return{template:'<ng-include src="getTemplateUrl()"/>',scope:{catagory:"=catagory"},restrict:"E",controller:["$scope",function(e){e.getTemplateUrl=function(){if(e.petName=e.catagory,void 0!=e.catagory)return"views/"+e.catagory+".html"}}]}}),app.directive("petDisplay",function(){return{template:'<ng-include src="displayPet()"/>',scope:!1,restrict:"E",controller:["$scope",function(e){e.displayPet=function(){return"views/pet-display.html"}}]}});