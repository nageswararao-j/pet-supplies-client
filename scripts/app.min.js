"use strict";var app=angular.module("petApp",["ngResource","ngRoute","ui.bootstrap","ui.router"]);app.config(["$routeProvider","$stateProvider","USER_ROLES",function(e,t,r){e.when("/login",{templateUrl:"views/login.html",controller:"LoginController",controllerAs:"login"}).when("/main",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).when("/header",{templateUrl:"views/header.html",controller:"controllers/TemplateController",controllerAs:"header"}).otherwise({redirectTo:"/login"}),t.state("index",{url:"/views",templateUrl:"views/index.html",data:{authorizedRoles:[r.admin,r.editor]}})}]),app.run(["$rootScope","ENVIRONMENT",function(e,t){e.baseUrl=t.baseUrl}]),app.factory("AuthService",["$http","$rootScope","Session",function(e,t,r){var n={};return n.login=function(n){return e.post(t.baseUrl+"/login",n).then(function(e){return r.create(e.data.emailId,e.data.userId,"admin"),e.data})},n.isAuthenticated=function(){return!!r.userId},n.currentUser=function(e){r.currentUser=e},n.isAuthorized=function(e){return n.isAuthenticated()},n}]),app.factory("CartService",["$http","$q","$rootScope",function(e,t,r){var n=function(t){return e.post(r.baseUrl+"/cart/save",t).success(function(e){console.log("Saved Cart Item successfully!")}).error(function(e){console.log("Error while saving Cart Item")})},o=function(t){return e.post(r.baseUrl+"/cart/delete",t).success(function(e){console.log("Deleted Cart Item successfully!")}).error(function(e){console.log("Error while Delete Cart Item")})},a=function(t){return e.post(r.baseUrl+"/cart/update",t).success(function(e){console.log("Updated Cart Item successfully!")}).error(function(e){console.log("Error while updating Cart Item")})},s=function(t){return e({url:r.baseUrl+"/cart/load/"+t,dataType:"json",data:"",headers:{"Content-Type":"application/json"}}).success(function(e){console.log("Loaded Cart Items successfully!")}).error(function(e){console.log("Error while loading Cart Items")})};return{saveCartItem:n,deleteCartItem:o,loadCartItems:s,updateCartItem:a}}]),app.constant("AUTH_EVENTS",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized"}),app.constant("USER_ROLES",{all:"*",admin:"admin",editor:"editor",guest:"guest"}),app.constant("ENVIRONMENT",{mode:"dev",baseUrl:"http://localhost:8080/pet-supplies"}),app.constant("ERROR",{}),app.service("LoginService",["$http","$q","$rootScope",function(e,t,r){var n=t.defer(),o=function(t){e({url:r.baseUrl+"/login",dataType:"json",method:"POST",data:t,headers:{"Content-Type":"application/json"}}).success(function(e){n.resolve(e)}).error(function(e){n.reject(),console.log("Failed to login")});return n.promise};return{loginToApp:o}}]),app.factory("ProductsService",["$http","$q","$rootScope",function(e,t,r){return{loadAllPets:function(n){var o=t.defer();e({url:r.baseUrl+"/category/"+n,dataType:"json",method:"GET",data:"",headers:{"Content-Type":"application/json"}}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)});return o.promise}}}]),app.factory("ReferentialDataService",[function(){return{getAllPets:function(){var e=[{code:"BIRD",name:"Birds"},{code:"CAT",name:"Cats"},{code:"DOG",name:"Dogs"}];return e}}}]),app.service("Session",function(){this.currentUser={},this.create=function(e,t,r){this.id=e,this.userId=t,this.userRole=r},this.destroy=function(){this.id=null,this.userId=null,this.userRole=null}}),app.controller("CheckoutController",["$scope","$modal",function(e,t){e.open=function(){t.open({templateUrl:"views/checkout.html"})},e.close=function(){$modalInstance.dismiss("cancel")}}]),app.controller("LoginController",["$scope","LoginService","$location","$rootScope","AuthService","AUTH_EVENTS","USER_ROLES",function(e,t,r,n,o,a,s){var c={emailId:"",password:""};e.credentials=c,e.invalidCredentials="",e.currentUser=null,e.userRoles=s,e.isAuthorized=o.isAuthorized(s),e.loginApp=function(){o.login(e.credentials).then(function(t){n.$broadcast(a.loginSuccess),e.setCurrentUser(t),o.isAuthorized()?(o.currentUser(e.currentUser),r.path("/main")):(e.invalidCredentials="Invalid credentials! Please check username & paswword",e.credentials=c,r.path("/login"))},function(){n.$broadcast(a.loginFailed)})},e.setCurrentUser=function(t){e.currentUser=t}}]),app.controller("MainCtrl",["$scope","ReferentialDataService","ProductsService","CartService","USER_ROLES","AuthService","$location","Session",function(e,t,r,n,o,a,s,c){e.cartItems={},n.loadCartItems(c.currentUser.userId).then(function(t){var r=t.data;void 0!=r&&r.length>0&&angular.forEach(r,function(t){e.cartItems[t.id]=t}),d()}),e.isItemsPresent=!1,e.currentUser=null,e.petsList=t.getAllPets(),e.userName=c.currentUser.userName,e.load=function(t){e.pettype=t,e.products=t,r.loadAllPets(t).then(function(t){e.catagories=t})},e.addToCart=function(t){e.isItemsPresent=!0;var r=l(t);i(r)?angular.forEach(e.cartItems,function(e,t){p(e,r)&&(e.quantity=r.quantity,n.updateCartItem(r))}):n.saveCartItem(r).then(function(t){e.cartItems[t.data.id]=t.data,d()})};var i=function(t){var r=!1;return angular.forEach(e.cartItems,function(e,n){f(e,t)&&(r=!0)}),r};e.showCartItems=function(){0!=e.cartItems.length&&(e.isItemsPresent=!0)},e.removeCartItem=function(t){i(t)&&(delete e.cartItems[t.id],u(t)),0==e.cartItems.length&&(e.isItemsPresent=!1)};var u=function(e){n.deleteCartItem(e),d()};e.setCurrentUser=function(t){e.currentUser=t};var l=function(e){var t={id:e.id,productId:e.productId,quantity:e.quantity,productName:e.productName,userId:c.currentUser.userId};return t},d=function(){e.cartItemSize=Object.keys(e.cartItems).length},p=function(e,t){return f(e,t)&&e.quantity!==t.quantity},f=function(e,t){return e.productId===t.productId&&e.userId===t.userId}}]),app.controller("ProductsController",["$scope",function(e){}]),app.directive("dynamicTemplate",function(){return{template:'<ng-include src="getTemplateUrl()"/>',scope:{catagory:"=catagory"},restrict:"E",controller:["$scope",function(e){e.getTemplateUrl=function(){if(e.petName=e.catagory,void 0!=e.catagory)return"views/"+e.catagory+".html"}}]}}),app.directive("petDisplay",function(){return{template:'<ng-include src="displayPet()"/>',scope:!1,restrict:"E",controller:["$scope",function(e){e.displayPet=function(){return"views/pet-display.html"}}]}});