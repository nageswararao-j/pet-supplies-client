"use strict";var app=angular.module("petApp",["ngResource","ngRoute","ui.bootstrap","ui.router"]);app.config(["$routeProvider","$stateProvider","USER_ROLES","ENVIRONMENT",function(e,t,r,n){var o="";"prod"===n.mode&&(o=n.baseUrl),e.when("/login",{templateUrl:o+"/views/login.html",controller:"LoginController",controllerAs:"login"}).when("/signUp",{templateUrl:o+"/views/signUp.html",controller:"SignUpController",controllerAs:"signUp"}).when("/main",{templateUrl:o+"/views/main.html",controller:"MainCtrl",controllerAs:"main"}).when("/order",{templateUrl:o+"/views/order.html",controller:"OrderController",controllerAs:"order"}).when("/orderHistory",{templateUrl:o+"/views/orderHistory.html",controller:"OrderHistoryController",controllerAs:"orderHistory"}).otherwise({redirectTo:"/"}),t.state("index",{url:"/views",templateUrl:o+"/index.html",data:{authorizedRoles:[r.admin,r.editor,r.newUser]}})}]),app.run(["$rootScope","ENVIRONMENT",function(e,t){e.baseUrl=t.baseUrl}]),app.factory("AuthService",["$http","$rootScope","Session","USER_ROLES","AUTH_EVENTS","ERROR",function(e,t,r,n,o,a){var s={};return s.login=function(s){return e.post(t.baseUrl+"/login",s).success(function(e){return r.create(e.emailId,e.userId,n.newUser),e}).error(function(e){e.present&&(console.log(a.EMAIL_EXISTS),t.$broadcast(o.existingUser,{errorMsg:a.EMAIL_EXISTS}))})},s.isAuthenticated=function(){return!!r.userId},s.currentUser=function(e){r.currentUser=e},s.isAuthorized=function(e){return s.isAuthenticated()},s}]),app.factory("CartService",["$http","$q","$rootScope",function(e,t,r){var n=function(t){return e.post(r.baseUrl+"/cart/save",t).success(function(e){console.log("Saved Cart Item successfully!")}).error(function(e){console.log("Error while saving Cart Item")})},o=function(t){return e.post(r.baseUrl+"/cart/delete",t).success(function(e){console.log("Deleted Cart Item successfully!")}).error(function(e){console.log("Error while Delete Cart Item")})},a=function(t){return e.post(r.baseUrl+"/cart/update",t).success(function(e){console.log("Updated Cart Item successfully!")}).error(function(e){console.log("Error while updating Cart Item")})},s=function(t){return e({url:r.baseUrl+"/cart/load/"+t,dataType:"json",data:"",headers:{"Content-Type":"application/json"}}).success(function(e){console.log("Loaded Cart Items successfully!")}).error(function(e){console.log("Error while loading Cart Items")})};return{saveCartItem:n,deleteCartItem:o,loadCartItems:s,updateCartItem:a}}]),app.constant("AUTH_EVENTS",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized",existingUser:"user-exists"}),app.constant("USER_ROLES",{all:"*",admin:"admin",editor:"editor",guest:"guest",newUser:"newUser"}),app.constant("ENVIRONMENT",{mode:"prod",baseUrl:"http://localhost:8080/pet-supplies"}),app.constant("ERROR",{EMAIL_EXISTS:"EmailId already exists! Please Login"}),app.constant("ORDERS",{received:"Order received",readyToShip:"Ready to ship",shipped:"Shipped",delivered:"Delivered",cancelled:"Cancelled"}),app.factory("OrderService",["$http","$q","$rootScope",function(e,t,r){var n=function(t){return e.post(r.baseUrl+"/order/save",t).success(function(e){console.log("Saved Order successfully!")}).error(function(e){console.log("Error while saving Order")})},o=function(t){return e({url:r.baseUrl+"/order/load/"+t,dataType:"json",method:"GET",data:"",headers:{"Content-Type":"application/json"}}).success(function(e){console.log("Loaded order successfully!")}).error(function(e){console.log("Error while loading orders !")})};return{placeOrder:n,loadOrders:o}}]),app.factory("PaymentService",["$http","$q","$rootScope",function(e,t,r){var n=function(t){return e.post(r.baseUrl+"/payment/place",t).success(function(e){console.log("payment successfully!")}).error(function(e){console.log("Error while payment!")})};return{savePayment:n}}]),app.factory("ProductsService",["$http","$q","$rootScope",function(e,t,r){return{loadAllPets:function(n){var o=t.defer();e({url:r.baseUrl+"/category/"+n,dataType:"json",method:"GET",data:"",headers:{"Content-Type":"application/json"}}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)});return o.promise}}}]),app.service("Session",function(){this.currentUser={},this.cartItems={},this.isItemsPresent={},this.create=function(e,t,r){this.id=e,this.userId=t,this.userRole=r},this.destroy=function(){this.id=null,this.userId=null,this.userRole=null}}),app.controller("LoginController",["$scope","$location","$rootScope","AuthService","AUTH_EVENTS","USER_ROLES","ENVIRONMENT",function(e,t,r,n,o,a,s){var c={emailId:"",password:""};e.credentials=c,e.invalidCredentials="",e.currentUser=null,e.userRoles=a,e.isAuthorized=n.isAuthorized(a),e.loginApp=function(){n.login(e.credentials).then(function(a){r.$broadcast(o.loginSuccess),e.setCurrentUser(a),n.isAuthorized()?(n.currentUser(e.currentUser),t.path("/main")):(e.invalidCredentials="Invalid credentials! Please check username & paswword",e.credentials=c,t.path("/login"))},function(){r.$broadcast(o.loginFailed)})},e.setCurrentUser=function(t){e.currentUser=t},e.signUp=function(){t.path("/signUp")}}]),app.controller("MainCtrl",["$scope","ProductsService","CartService","USER_ROLES","AuthService","$location","Session",function(e,t,r,n,o,a,s){e.cartItems={},e.petsList={},r.loadCartItems(s.currentUser.data.userId).then(function(t){var r=t.data;void 0!=r&&r.length>0&&angular.forEach(r,function(t){e.cartItems[t.id]=t}),l()}),e.isItemsPresent=!1,e.currentUser=null,t.loadAllPets("ALL").then(function(t){e.petsList=t}),e.userName=s.currentUser.data.userName,e.load=function(r){e.pettype=r,e.products=r,t.loadAllPets(r).then(function(t){e.catagories=t})},e.addToCart=function(t){e.isItemsPresent=!0;var n=u(t);c(n)?angular.forEach(e.cartItems,function(e,t){d(e,n)&&(e.quantity=n.quantity,r.updateCartItem(n))}):r.saveCartItem(n).then(function(t){e.cartItems[t.data.id]=t.data,l()})};var c=function(t){var r=!1;return angular.forEach(e.cartItems,function(e,n){p(e,t)&&(r=!0)}),r};e.showCartItems=function(){0!=e.cartItems.length&&(e.isItemsPresent=!0)},e.removeCartItem=function(t){c(t)&&(delete e.cartItems[t.id],i(t)),0===e.cartItems.length&&(e.isItemsPresent=!1)};var i=function(e){r.deleteCartItem(e),l()};e.setCurrentUser=function(t){e.currentUser=t};var u=function(e){var t={id:e.id,productId:e.productId,quantity:e.quantity,productName:e.productName,price:e.price,currency:e.currency,userId:s.currentUser.data.userId};return t},l=function(){e.cartItemSize=Object.keys(e.cartItems).length},d=function(e,t){return p(e,t)&&e.quantity!=t.quantity},p=function(e,t){return e.productId===t.productId&&e.userId===t.userId};e.navToOrderHistory=function(){a.path("/orderHistory")},s.cartItems=e.cartItems,e.signOut=function(){s.currentUser=null,a.path("/login")}}]),app.controller("OrderController",["$scope","$location","Session","OrderService","CartService","ORDERS",function(e,t,r,n,o,a){e.currentUser=r.currentUser.data,e.cartItems=r.cartItems,e.userName=r.currentUser.data.userName,e.cartItemSize=Object.keys(e.cartItems).length,e.cartItemSize>0&&(e.isItemsPresent=!0),e.load=function(e){t.path("/main")};var s=r.currentUser.data.address;e.address=s.address,e.userName=e.currentUser.userName,e.city=s.city,e.state=s.state,e.zipCode=s.zipCode,e.email=s.email,e.phone=s.phone,e.country=s.country,e.payAndPlaceOrder=function(){var t=[];angular.forEach(e.cartItems,function(e,r){void 0!=e&&t.push(c(e))}),t.length>0&&(n.placeOrder(t).then(function(t){e.orders=t.data}),console.log("Ordered placed successfully !"),u())};var c=function(t){var r={};return r.userId=e.currentUser.userId,r.productId=t.productId,r.productName=t.productName,r.productPrice=t.price,r.currency=t.currency,r.quantity=t.quantity,r.status=a.received,r.shippingAddress=i(),r.orderDate=new Date,r},i=function(){var t=" , ";return e.userName+t+e.address+t+e.city+t+e.state+t+e.zipCode+t+e.email+t+e.phone+t+e.country},u=function(){angular.forEach(e.cartItems,function(e,t){void 0!=e&&o.deleteCartItem(e)}),t.path("/orderHistory")}}]),app.controller("OrderHistoryController",["$scope","$location","Session","OrderService",function(e,t,r,n){e.orderedProducts={},n.loadOrders(r.currentUser.data.userId).then(function(t){e.orderedProducts=t.data}),e.load=function(e){t.path("/main")},e.cartItems={}}]),app.controller("PlaceOrderController",["$scope","$modalInstance","items","CartService","$location",function(e,t,r,n,o){e.itemsInPopup=r,e.totalPrice=function(){var t=0,n=1;return angular.forEach(r,function(r,o){void 0!=r&&(n=parseInt(r.quantity),t+=n*parseInt(r.price),e.currencyToPay=r.currency)}),t}(),e.onChangeQuantity=function(e){n.updateCartItem(e)},e.deleteCartItem=function(e){n.deleteCartItem(e)},e.proceedToPay=function(){o.path("/order"),t.dismiss("cancel")},e.close=function(){t.dismiss("cancel")}}]),app.controller("PopupsController",["$scope","$modal",function(e,t){e.openPlaceOrder=function(e){t.open({templateUrl:"views/checkout.html",controller:"PlaceOrderController",resolve:{items:function(){return e}}})}}]),app.controller("SignUpController",["$scope","$location","Session","AuthService","USER_ROLES","AUTH_EVENTS",function(e,t,r,n,o,a){e.signUpToApp=function(){e.user=s(),n.login(e.user).then(function(r){void 0!=r&&r.active&&(e.currentUser=r,n.currentUser(r),t.path("/main"))})};var s=function(){var t={};return t.userName=e.userName,t.password=e.password,t.emailId=e.email,t.address=c(),t.phone=e.phone,t.register=!0,t.profile=o.newUser,t},c=function(){var t={};return t.address=e.doorNum,t.city=e.city,t.state=e.state,t.zipCode=e.zipCode,t.email=e.email,t.phone=e.phone,t.country=e.country,t};e.login=function(){t.path("/login")},e.$on(a.existingUser,function(t,r){console.log(r.errorMsg),e.emailPresent=r.errorMsg})}]),app.directive("dynamicTemplate",function(){return{template:'<ng-include src="getTemplateUrl()"/>',scope:{catagory:"=catagory"},restrict:"E",controller:["$scope",function(e){e.getTemplateUrl=function(){if(e.petName=e.catagory,void 0!=e.catagory)return"views/"+e.catagory+".html"}}]}}),app.filter("millSecondsToDateString",function(){return function(e){var t=new Date(e);return t.toLocaleDateString()}}),app.directive("petDisplay",function(){return{template:'<ng-include src="displayPet()"/>',scope:!1,restrict:"E",controller:["$scope",function(e){e.displayPet=function(){return"views/pet-display.html"}}]}}),app.directive("validateEmail",function(){var e=/^[_a-z0-9]+(\.[_a-z0-9]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,4})$/;return{require:"ngModel",restrict:"",link:function(t,r,n,o){o&&o.$validators.email&&(o.$validators.email=function(t){return o.$isEmpty(t)||e.test(t)})}}});